{% extends 'base.html' %}
{% load static %}

{% block title %}Delivery Address - StreetEats Connect{% endblock %}

{% block extra_css %}
<style>
.address-container {
    max-width: 800px;
    margin: 100px auto 50px;
    padding: 0 20px;
}

.address-header {
    text-align: center;
    margin-bottom: 40px;
}

.address-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 10px;
}

.address-subtitle {
    color: #666;
    font-size: 16px;
}

.address-form-container {
    background: white;
    border-radius: 15px;
    padding: 40px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.form-section {
    margin-bottom: 30px;
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: white;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: #ff6b35;
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.address-type-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.address-type-option {
    position: relative;
}

.address-type-radio {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.address-type-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.address-type-radio:checked + .address-type-label {
    border-color: #ff6b35;
    background: rgba(255, 107, 53, 0.05);
}

.address-type-icon {
    font-size: 1.5rem;
    color: #ff6b35;
    margin-bottom: 8px;
}

.address-type-text {
    font-weight: 600;
    color: #333;
}

.saved-addresses {
    margin-bottom: 30px;
}

.saved-address-item {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.saved-address-item:hover {
    border-color: #ff6b35;
}

.saved-address-item.selected {
    border-color: #ff6b35;
    background: rgba(255, 107, 53, 0.05);
}

.saved-address-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 10px;
}

.saved-address-type {
    background: #ff6b35;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.saved-address-actions {
    display: flex;
    gap: 10px;
}

.address-action-btn {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
    transition: all 0.3s ease;
}

.address-action-btn:hover {
    background: #e9ecef;
    color: #333;
}

.saved-address-details {
    color: #666;
    line-height: 1.5;
}

.add-new-address-btn {
    width: 100%;
    padding: 15px;
    background: rgba(255, 107, 53, 0.1);
    border: 2px dashed #ff6b35;
    border-radius: 10px;
    color: #ff6b35;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.add-new-address-btn:hover {
    background: rgba(255, 107, 53, 0.2);
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 30px;
}

.btn {
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-primary {
    background: #ff6b35;
    color: white;
}

.btn-primary:hover {
    background: #e55a2b;
    transform: translateY(-2px);
}

.location-finder {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.location-finder-btn {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.location-finder-btn:hover {
    background: #138496;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    border: 1px solid #f5c6cb;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    border: 1px solid #c3e6cb;
}

@media (max-width: 768px) {
    .address-container {
        margin-top: 80px;
        padding: 0 15px;
    }
    
    .address-form-container {
        padding: 20px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .address-type-selector {
        grid-template-columns: 1fr 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="address-container">
    <div class="address-header">
        <h1 class="address-title">
            <i class="fas fa-map-marker-alt"></i>
            Delivery Address
        </h1>
        <p class="address-subtitle">Choose or add a delivery address for your order</p>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="{% if message.tags == 'error' %}error-message{% else %}success-message{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Saved Addresses -->
    {% if saved_addresses %}
    <div class="address-form-container">
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-bookmark"></i>
                Saved Addresses
            </h2>
            <div class="saved-addresses">
                {% for address in saved_addresses %}
                <div class="saved-address-item" onclick="selectAddress({{ address.id }})">
                    <div class="saved-address-header">
                        <span class="saved-address-type">{{ address.address_type|title }}</span>
                        <div class="saved-address-actions">
                            <button class="address-action-btn" onclick="editAddress({{ address.id }})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="address-action-btn" onclick="deleteAddress({{ address.id }})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="saved-address-details">
                        <strong>{{ address.full_name }}</strong><br>
                        {{ address.address_line_1 }}<br>
                        {% if address.address_line_2 %}{{ address.address_line_2 }}<br>{% endif %}
                        {{ address.city }}, {{ address.state }} {{ address.pincode }}<br>
                        <i class="fas fa-phone"></i> {{ address.phone }}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <button class="add-new-address-btn" onclick="showAddressForm()">
                <i class="fas fa-plus"></i>
                Add New Address
            </button>
        </div>
    </div>
    {% endif %}
    
    <!-- Add New Address Form -->
    <div class="address-form-container" id="addressForm" {% if saved_addresses %}style="display: none;"{% endif %}>
        <form method="post" action="{% url 'orders:save_address' %}">
            {% csrf_token %}
            
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-plus"></i>
                    Add New Address
                </h2>
                
                <!-- Location Finder -->
                <div class="location-finder">
                    <p><strong>Quick Location:</strong> Use your current location to auto-fill address details</p>
                    <button type="button" class="location-finder-btn" onclick="getCurrentLocation()">
                        <i class="fas fa-location-arrow"></i>
                        Use Current Location
                    </button>
                </div>
                
                <!-- Address Type -->
                <div class="form-group">
                    <label class="form-label">Address Type</label>
                    <div class="address-type-selector">
                        <div class="address-type-option">
                            <input type="radio" name="address_type" value="home" id="type_home" class="address-type-radio" checked>
                            <label for="type_home" class="address-type-label">
                                <i class="fas fa-home address-type-icon"></i>
                                <span class="address-type-text">Home</span>
                            </label>
                        </div>
                        <div class="address-type-option">
                            <input type="radio" name="address_type" value="work" id="type_work" class="address-type-radio">
                            <label for="type_work" class="address-type-label">
                                <i class="fas fa-briefcase address-type-icon"></i>
                                <span class="address-type-text">Work</span>
                            </label>
                        </div>
                        <div class="address-type-option">
                            <input type="radio" name="address_type" value="other" id="type_other" class="address-type-radio">
                            <label for="type_other" class="address-type-label">
                                <i class="fas fa-map-marker-alt address-type-icon"></i>
                                <span class="address-type-text">Other</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Personal Details -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="full_name" class="form-label">Full Name *</label>
                        <input type="text" id="full_name" name="full_name" class="form-input" required 
                               value="{{ user.first_name }} {{ user.last_name }}">
                    </div>
                    <div class="form-group">
                        <label for="phone" class="form-label">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" class="form-input" required>
                    </div>
                </div>
                
                <!-- Address Details -->
                <div class="form-group">
                    <label for="address_line_1" class="form-label">Address Line 1 *</label>
                    <input type="text" id="address_line_1" name="address_line_1" class="form-input" required
                           placeholder="House/Flat/Office No., Building Name">
                </div>
                
                <div class="form-group">
                    <label for="address_line_2" class="form-label">Address Line 2</label>
                    <input type="text" id="address_line_2" name="address_line_2" class="form-input"
                           placeholder="Street Name, Area, Locality">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="city" class="form-label">City *</label>
                        <input type="text" id="city" name="city" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="state" class="form-label">State *</label>
                        <select id="state" name="state" class="form-select" required>
                            <option value="">Select State</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                            <option value="Delhi">Delhi</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="pincode" class="form-label">PIN Code *</label>
                        <input type="text" id="pincode" name="pincode" class="form-input" required
                               pattern="[0-9]{6}" maxlength="6" placeholder="6-digit PIN code">
                    </div>
                    <div class="form-group">
                        <label for="landmark" class="form-label">Landmark</label>
                        <input type="text" id="landmark" name="landmark" class="form-input"
                               placeholder="Near landmark (optional)">
                    </div>
                </div>
                
                <!-- Special Instructions -->
                <div class="form-group">
                    <label for="delivery_instructions" class="form-label">Delivery Instructions</label>
                    <textarea id="delivery_instructions" name="delivery_instructions" class="form-textarea"
                              placeholder="Any special instructions for delivery (optional)"></textarea>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                    Back to Cart
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i>
                    Save & Continue
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let selectedAddressId = null;

function selectAddress(addressId) {
    // Remove previous selection
    document.querySelectorAll('.saved-address-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Add selection to clicked item
    event.currentTarget.classList.add('selected');
    selectedAddressId = addressId;
    
    // Show continue button
    showContinueButton();
}

function showContinueButton() {
    if (selectedAddressId) {
        // Create continue button if it doesn't exist
        let continueBtn = document.getElementById('continueBtn');
        if (!continueBtn) {
            const container = document.querySelector('.saved-addresses').parentNode;
            const btnContainer = document.createElement('div');
            btnContainer.className = 'form-actions';
            btnContainer.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                    Back to Cart
                </button>
                <button type="button" id="continueBtn" class="btn btn-primary" onclick="continueWithAddress()">
                    <i class="fas fa-arrow-right"></i>
                    Continue to Payment
                </button>
            `;
            container.appendChild(btnContainer);
        }
    }
}

function continueWithAddress() {
    if (selectedAddressId) {
        window.location.href = `/orders/checkout/?address_id=${selectedAddressId}`;
    }
}

function showAddressForm() {
    document.getElementById('addressForm').style.display = 'block';
    document.getElementById('addressForm').scrollIntoView({ behavior: 'smooth' });
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Use reverse geocoding to get address
            fetch(`https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=YOUR_API_KEY`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const result = data.results[0];
                        const components = result.components;
                        
                        // Fill form fields
                        document.getElementById('address_line_1').value = components.house_number || '';
                        document.getElementById('address_line_2').value = components.road || '';
                        document.getElementById('city').value = components.city || components.town || '';
                        document.getElementById('state').value = components.state || '';
                        document.getElementById('pincode').value = components.postcode || '';
                    }
                })
                .catch(error => {
                    console.error('Error getting location details:', error);
                    alert('Could not get location details. Please fill manually.');
                });
        }, function(error) {
            alert('Location access denied. Please fill address manually.');
        });
    } else {
        alert('Geolocation is not supported by this browser.');
    }
}

function editAddress(addressId) {
    event.stopPropagation();
    // Implement edit functionality
    window.location.href = `/orders/edit-address/${addressId}/`;
}

function deleteAddress(addressId) {
    event.stopPropagation();
    if (confirm('Are you sure you want to delete this address?')) {
        fetch(`/orders/delete-address/${addressId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting address');
            }
        });
    }
}

function goBack() {
    window.location.href = '{% url "orders:cart" %}';
}

// PIN code validation
document.getElementById('pincode').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
});
</script>
{% endblock %}