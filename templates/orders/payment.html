{% extends 'base.html' %}
{% load static %}

{% block title %}Payment - StreetEats Connect{% endblock %}

{% block extra_css %}
<style>
.payment-container {
    max-width: 1000px;
    margin: 100px auto 50px;
    padding: 0 20px;
}

.payment-header {
    text-align: center;
    margin-bottom: 40px;
}

.payment-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 10px;
}

.payment-subtitle {
    color: #666;
    font-size: 16px;
}

.payment-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
}

.payment-methods {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.section-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.payment-method-option {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.payment-method-option:hover {
    border-color: #2f43a5;
}

.payment-method-option.selected {
    border-color: #2f43a5;
    background: rgba(255, 107, 53, 0.05);
}

.payment-method-radio {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.payment-method-content {
    display: flex;
    align-items: center;
    gap: 15px;
}

.payment-method-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.razorpay-icon {
    background: linear-gradient(135deg, #3395ff, #1976d2);
}

.cod-icon {
    background: linear-gradient(135deg, #28a745, #1e7e34);
}

.upi-icon {
    background: linear-gradient(135deg, #ff9800, #f57c00);
}

.payment-method-details {
    flex: 1;
}

.payment-method-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.payment-method-desc {
    color: #666;
    font-size: 14px;
}

.payment-method-badge {
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.order-summary {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    height: fit-content;
    position: sticky;
    top: 100px;
}

.delivery-address-summary {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
}

.address-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.address-type-badge {
    background: #2f43a5;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.change-address-btn {
    background: none;
    border: none;
    color: #2f43a5;
    font-weight: 600;
    cursor: pointer;
    text-decoration: underline;
}

.address-details {
    color: #666;
    line-height: 1.5;
}

.order-items {
    margin-bottom: 25px;
}

.order-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.order-item:last-child {
    border-bottom: none;
}

.item-details {
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.item-meta {
    color: #666;
    font-size: 14px;
}

.item-price {
    font-weight: 600;
    color: #333;
}

.price-breakdown {
    border-top: 2px solid #f0f0f0;
    padding-top: 20px;
    margin-top: 20px;
}

.price-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.price-row.total {
    font-weight: 700;
    font-size: 1.1rem;
    color: #333;
    border-top: 1px solid #e9ecef;
    padding-top: 15px;
    margin-top: 15px;
}

.pay-button {
    width: 100%;
    background: #2f43a5;
    color: white;
    border: none;
    padding: 15px;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
}

.pay-button:hover {
    background: #1e2d6b;
    transform: translateY(-2px);
}

.pay-button:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

.security-info {
    background: #e8f5e8;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    text-align: center;
}

.security-info i {
    color: #28a745;
    margin-right: 8px;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #2f43a5;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .payment-container {
        margin-top: 80px;
        padding: 0 15px;
    }
    
    .payment-content {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .order-summary {
        position: static;
        order: -1;
    }
    
    .payment-methods {
        padding: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="payment-container">
    <div class="payment-header">
        <h1 class="payment-title">
            <i class="fas fa-credit-card"></i>
            Complete Payment
        </h1>
        <p class="payment-subtitle">Choose your preferred payment method to complete your order</p>
    </div>
    
    <div class="payment-content">
        <div class="payment-methods">
            <h2 class="section-title">
                <i class="fas fa-wallet"></i>
                Payment Methods
            </h2>
            
            <form id="paymentForm">
                {% csrf_token %}
                
                <!-- Razorpay -->
                <div class="payment-method-option selected" onclick="selectPaymentMethod('razorpay')">
                    <input type="radio" name="payment_method" value="razorpay" id="razorpay" class="payment-method-radio" checked>
                    <div class="payment-method-content">
                        <div class="payment-method-icon razorpay-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-method-details">
                            <div class="payment-method-title">Credit/Debit Card, UPI, Net Banking</div>
                            <div class="payment-method-desc">Secure payment via Razorpay</div>
                        </div>
                        <span class="payment-method-badge">Recommended</span>
                    </div>
                </div>
                
                <!-- UPI -->
                <div class="payment-method-option" onclick="selectPaymentMethod('upi')">
                    <input type="radio" name="payment_method" value="upi" id="upi" class="payment-method-radio">
                    <div class="payment-method-content">
                        <div class="payment-method-icon upi-icon">
                            <i class="fab fa-google-pay"></i>
                        </div>
                        <div class="payment-method-details">
                            <div class="payment-method-title">UPI Payment</div>
                            <div class="payment-method-desc">Pay using Google Pay, PhonePe, Paytm</div>
                        </div>
                    </div>
                </div>
                
                <!-- Cash on Delivery -->
                <div class="payment-method-option" onclick="selectPaymentMethod('cod')">
                    <input type="radio" name="payment_method" value="cod" id="cod" class="payment-method-radio">
                    <div class="payment-method-content">
                        <div class="payment-method-icon cod-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="payment-method-details">
                            <div class="payment-method-title">Cash on Delivery</div>
                            <div class="payment-method-desc">Pay when your order is delivered</div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="order-summary">
            <h2 class="section-title">
                <i class="fas fa-receipt"></i>
                Order Summary
            </h2>
            
            <!-- Delivery Address -->
            <div class="delivery-address-summary">
                <div class="address-header">
                    <span class="address-type-badge">{{ address.address_type|title }}</span>
                    <button class="change-address-btn" onclick="changeAddress()">Change</button>
                </div>
                <div class="address-details">
                    <strong>{{ address.full_name }}</strong><br>
                    {{ address.address_line_1 }}<br>
                    {% if address.address_line_2 %}{{ address.address_line_2 }}<br>{% endif %}
                    {{ address.city }}, {{ address.state }} {{ address.pincode }}<br>
                    <i class="fas fa-phone"></i> {{ address.phone }}
                </div>
            </div>
            
            <!-- Order Items -->
            <div class="order-items">
                {% for item in cart_items %}
                <div class="order-item">
                    <div class="item-details">
                        <div class="item-name">{{ item.product.name }}</div>
                        <div class="item-meta">{{ item.quantity }} {{ item.product.unit }} × ₹{{ item.product.price }}</div>
                    </div>
                    <div class="item-price">₹{{ item.total_price }}</div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Price Breakdown -->
            <div class="price-breakdown">
                <div class="price-row">
                    <span>Subtotal</span>
                    <span>₹{{ subtotal }}</span>
                </div>
                <div class="price-row">
                    <span>Delivery Fee</span>
                    <span>₹{{ delivery_fee }}</span>
                </div>
                <div class="price-row">
                    <span>GST (18%)</span>
                    <span>₹{{ gst_amount }}</span>
                </div>
                <div class="price-row total">
                    <span>Total Amount</span>
                    <span>₹{{ total_amount }}</span>
                </div>
            </div>
            
            <button class="pay-button" onclick="processPayment()">
                <i class="fas fa-lock"></i>
                Pay ₹{{ total_amount }}
            </button>
            
            <div class="security-info">
                <i class="fas fa-shield-alt"></i>
                Your payment information is secure and encrypted
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Processing your payment...</p>
    </div>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
let selectedPaymentMethod = 'razorpay';

function selectPaymentMethod(method) {
    // Remove previous selection
    document.querySelectorAll('.payment-method-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selection to clicked option
    event.currentTarget.classList.add('selected');
    
    // Update radio button
    document.getElementById(method).checked = true;
    selectedPaymentMethod = method;
}

function changeAddress() {
    window.location.href = '{% url "orders:delivery_address" %}';
}

function processPayment() {
    const payButton = document.querySelector('.pay-button');
    payButton.disabled = true;
    payButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    if (selectedPaymentMethod === 'cod') {
        // Handle Cash on Delivery
        processCODOrder();
    } else {
        // Handle online payment via Razorpay
        initiateRazorpayPayment();
    }
}

function processCODOrder() {
    fetch('{% url "orders:process_payment" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            payment_method: 'cod',
            address_id: {{ address.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/orders/success/${data.order_id}/`;
        } else {
            alert('Error processing order: ' + data.message);
            resetPayButton();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your order');
        resetPayButton();
    });
}

function initiateRazorpayPayment() {
    // Create Razorpay order
    fetch('{% url "orders:create_razorpay_order" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            address_id: {{ address.id }},
            amount: {{ total_amount }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            openRazorpayCheckout(data.order_id, data.amount);
        } else {
            alert('Error creating payment order: ' + data.message);
            resetPayButton();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while initiating payment');
        resetPayButton();
    });
}

function openRazorpayCheckout(orderId, amount) {
    const options = {
        key: '{{ razorpay_key_id }}',
        amount: amount * 100, // Amount in paise
        currency: 'INR',
        name: 'StreetEats Connect',
        description: 'Order Payment',
        order_id: orderId,
        handler: function(response) {
            // Payment successful
            verifyPayment(response);
        },
        prefill: {
            name: '{{ user.first_name }} {{ user.last_name }}',
            email: '{{ user.email }}',
            contact: '{{ address.phone }}'
        },
        theme: {
            color: '#2f43a5'
        },
        modal: {
            ondismiss: function() {
                resetPayButton();
            }
        }
    };
    
    const rzp = new Razorpay(options);
    rzp.open();
}

function verifyPayment(response) {
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    fetch('{% url "orders:verify_payment" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
            address_id: {{ address.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingOverlay').style.display = 'none';
        
        if (data.success) {
            window.location.href = `/orders/success/${data.order_id}/`;
        } else {
            alert('Payment verification failed: ' + data.message);
            resetPayButton();
        }
    })
    .catch(error => {
        document.getElementById('loadingOverlay').style.display = 'none';
        console.error('Error:', error);
        alert('An error occurred while verifying payment');
        resetPayButton();
    });
}

function resetPayButton() {
    const payButton = document.querySelector('.pay-button');
    payButton.disabled = false;
    payButton.innerHTML = '<i class="fas fa-lock"></i> Pay ₹{{ total_amount }}';
}
</script>
{% endblock %}